name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Disable incremental compilation for CI (faster clean builds)
  CARGO_INCREMENTAL: 0
  # Enable cargo sparse registry for faster dependency downloads
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # Linting - Fast feedback on code quality
  lint:
    name: Lint (rustfmt + clippy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          # Cache key based on job name and Cargo.lock
          shared-key: "lint"

      - name: Check code formatting
        run: cargo fmt --all --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Testing - Run tests across all platforms
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-${{ matrix.os }}"

      - name: Run tests
        run: cargo test --all-features --verbose

      - name: Run doc tests
        run: cargo test --doc --all-features

  # Security auditing - Check for known vulnerabilities
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "security"

      - name: Install cargo-deny
        run: cargo install --locked cargo-deny

      - name: Install cargo-audit
        run: cargo install --locked cargo-audit

      - name: Run cargo-deny
        run: cargo deny check

      - name: Run cargo-audit
        run: cargo audit

  # Build release binaries for all platforms
  build-release:
    name: Build Release (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: serial_mcp_agent
            asset_name: serial_mcp_agent-linux-x86_64

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: serial_mcp_agent.exe
            asset_name: serial_mcp_agent-windows-x86_64.exe

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: serial_mcp_agent
            asset_name: serial_mcp_agent-macos-x86_64

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: serial_mcp_agent
            asset_name: serial_mcp_agent-macos-aarch64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-${{ matrix.target }}"

      - name: Build release binary
        run: cargo build --release --all-features --target ${{ matrix.target }}

      - name: Strip binary (Linux and macOS)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          if-no-files-found: error

  # Optional: Create release on tags
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-release, security]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # MCP Server Validation - Ensures MCP protocol compliance
  mcp-validation:
    name: MCP Server Validation
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "mcp-validation"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build MCP server
        run: cargo build --release --features mcp

      - name: Validate mcp.json schema
        run: |
          python3 -c "import json; data=json.load(open('mcp.json')); print(f'✓ mcp.json valid: {data[\"name\"]} v{data[\"version\"]} with {len(data[\"tools\"])} tools')"

      - name: Verify MCP binary exists
        run: |
          if [ -f "target/release/serial_mcp_agent" ]; then
            echo "✓ MCP server binary built successfully"
            ls -la target/release/serial_mcp_agent
          else
            echo "✗ MCP server binary not found"
            exit 1
          fi

      - name: Run MCP server smoke test
        run: |
          # Start server in background, send initialize request, verify response
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"ci-test","version":"1.0"}}}' | timeout 5 ./target/release/serial_mcp_agent 2>/dev/null | head -1 | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'result' in d, 'No result'; print('✓ MCP initialize response valid')" || echo "⚠ MCP smoke test skipped (no TTY)"

  # Service Layer Tests - Verifies business logic decoupling
  service-tests:
    name: Service Layer Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "service-${{ matrix.os }}"

      - name: Run service layer unit tests
        run: cargo test service --all-features --verbose

      - name: Run service integration tests
        run: cargo test --test '*' --all-features -- service

  # Hardware Tests - Optional job for self-hosted runners with hardware
  hardware-tests:
    name: Hardware Tests
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[hardware]')
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Detect available serial ports
        run: |
          echo "Available serial ports:"
          if command -v ls &> /dev/null; then
            ls /dev/tty* 2>/dev/null | grep -E '(USB|ACM|serial)' || echo "No USB serial ports found"
          fi
          if command -v powershell &> /dev/null; then
            powershell -Command "Get-WMIObject Win32_SerialPort | Select-Object DeviceID, Description"
          fi

      - name: Run hardware tests
        env:
          SERIAL_TEST_PORT: ${{ secrets.SERIAL_TEST_PORT }}
          SERIAL_TEST_BAUD: ${{ secrets.SERIAL_TEST_BAUD }}
        run: |
          if [ -n "$SERIAL_TEST_PORT" ]; then
            cargo test --test integration_hardware --features auto-negotiation -- --ignored
          else
            echo "⚠ SERIAL_TEST_PORT not configured, skipping hardware tests"
          fi

  # Code coverage (optional but recommended)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "coverage"

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
