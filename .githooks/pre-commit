#!/bin/bash
# Pre-commit hook for rust-comm serial MCP server
# Install with: git config core.hooksPath .githooks
# Or run: make hooks-install

set -e

echo "üîç Running pre-commit checks for rust-comm..."
echo ""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall success
FAILED=0

# 1. Format check
echo "üìù Checking code formatting..."
if cargo fmt --all -- --check; then
    echo -e "${GREEN}‚úì${NC} Formatting check passed"
else
    echo -e "${RED}‚úó${NC} Formatting check failed"
    echo -e "${YELLOW}Run: cargo fmt --all${NC}"
    FAILED=1
fi
echo ""

# 2. Clippy linting
echo "üìé Running clippy (all targets, all features)..."
if cargo clippy --all-targets --all-features -- -D warnings; then
    echo -e "${GREEN}‚úì${NC} Clippy passed"
else
    echo -e "${RED}‚úó${NC} Clippy found issues"
    FAILED=1
fi
echo ""

# 3. Quick unit tests
echo "üß™ Running unit tests..."
if cargo test --lib --all-features; then
    echo -e "${GREEN}‚úì${NC} Unit tests passed"
else
    echo -e "${RED}‚úó${NC} Unit tests failed"
    FAILED=1
fi
echo ""

# 4. Service layer tests
echo "üîß Running service layer tests..."
if cargo test service --all-features; then
    echo -e "${GREEN}‚úì${NC} Service layer tests passed"
else
    echo -e "${RED}‚úó${NC} Service layer tests failed"
    FAILED=1
fi
echo ""

# 5. Documentation check
echo "üìö Checking documentation builds..."
if cargo doc --no-deps --all-features --quiet; then
    echo -e "${GREEN}‚úì${NC} Documentation check passed"
else
    echo -e "${RED}‚úó${NC} Documentation check failed"
    FAILED=1
fi
echo ""

# 6. MCP server validation (quick smoke test)
echo "üîå Validating MCP server binary..."
if cargo build --release --features mcp --quiet; then
    # Check if binary exists and has expected size
    if [ -f "target/release/serial_mcp_agent" ] || [ -f "target/release/serial_mcp_agent.exe" ]; then
        echo -e "${GREEN}‚úì${NC} MCP server binary built successfully"
    else
        echo -e "${RED}‚úó${NC} MCP server binary not found"
        FAILED=1
    fi
else
    echo -e "${RED}‚úó${NC} MCP server build failed"
    FAILED=1
fi
echo ""

# 7. Validate mcp.json schema
echo "üìã Validating mcp.json..."
if [ -f "mcp.json" ]; then
    # Check if mcp.json is valid JSON
    if python3 -c "import json; json.load(open('mcp.json'))" 2>/dev/null || python -c "import json; json.load(open('mcp.json'))" 2>/dev/null; then
        echo -e "${GREEN}‚úì${NC} mcp.json is valid JSON"
    else
        echo -e "${RED}‚úó${NC} mcp.json is not valid JSON"
        FAILED=1
    fi
else
    echo -e "${YELLOW}‚ö†${NC}  mcp.json not found"
fi
echo ""

# 8. Cargo deny check (if installed)
if command -v cargo-deny &> /dev/null; then
    echo "üîí Running cargo deny (dependencies, licenses, advisories)..."
    if cargo deny check 2>&1; then
        echo -e "${GREEN}‚úì${NC} Cargo deny passed"
    else
        # Cargo deny may fail for upstream dependencies we can't control
        echo -e "${YELLOW}‚ö†${NC}  Cargo deny found issues (review deny.toml for ignored advisories)"
        # Don't fail build for dependency issues we've acknowledged in deny.toml
    fi
    echo ""
else
    echo -e "${YELLOW}‚ö†${NC}  cargo-deny not installed (optional check skipped)"
    echo "   Install with: cargo install cargo-deny"
    echo ""
fi

# 9. Cargo audit check (if installed)
if command -v cargo-audit &> /dev/null; then
    echo "üõ°Ô∏è  Running cargo audit (security advisories)..."
    if cargo audit; then
        echo -e "${GREEN}‚úì${NC} Cargo audit passed"
    else
        echo -e "${YELLOW}‚ö†${NC}  Cargo audit found advisories (review required)"
        # Don't fail on audit warnings, just warn
    fi
    echo ""
else
    echo -e "${YELLOW}‚ö†${NC}  cargo-audit not installed (optional check skipped)"
    echo "   Install with: cargo install cargo-audit"
    echo ""
fi

# Final result
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo ""
    echo "Fix the issues above before committing."
    echo "Or use 'git commit --no-verify' to bypass (not recommended)."
    echo ""
    exit 1
fi
